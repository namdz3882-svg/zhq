<!-- 
    ========================================================================
    【Vercel 部署指南 / Vercel Deployment Guide】
    
    如果部署后显示 404 Not Found，请检查以下设置：
    If you see 404 Not Found after deployment, check these settings:

    1. 文件名 (Filename): 
       确保此文件名为 "index.html" 且位于仓库根目录。
       Make sure this file is named "index.html" and is in the root directory.

    2. Vercel 设置 (Settings -> Build & Development):
       - Framework Preset: 选择 "Other" (不要选 Next.js 或 React)
       - Build Command: 开启 Override 并留空 (Empty)
       - Output Directory: 开启 Override 并留空 (Empty)
    
    3. 保存后重新部署 (Redeploy)。
    ========================================================================
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通用分级排序器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义滚动条样式 (保留用于备选库，主区域已取消滚动) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .drag-over { background-color: rgba(255, 255, 255, 0.1) !important; }
        textarea:focus { outline: none; }
        
        /* 增加淡入动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 关键：允许子元素溢出显示 (用于hover浮起效果) */
        .tier-container {
            overflow: visible; 
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen flex flex-col items-center p-4">

    <!-- 应用挂载点 -->
    <div id="app" class="w-full max-w-5xl flex flex-col items-center gap-6"></div>

    <!-- 逻辑脚本 -->
    <script>
        // --- 图标 SVG 配置 ---
        const ICONS = {
            upload: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
            grip: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>`,
            rotate: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>`
        };

        // --- 初始数据 ---
        const INITIAL_TIERS = [
            { id: 'tier-1', label: '夯', color: 'bg-red-600', textColor: 'text-white', items: [] },
            { id: 'tier-2', label: '顶级', color: 'bg-orange-500', textColor: 'text-white', items: [] },
            { id: 'tier-3', label: '人上人', color: 'bg-yellow-400', textColor: 'text-black', items: [] },
            { id: 'tier-4', label: 'NPC', color: 'bg-[#eecfa1]', textColor: 'text-black', items: [] },
            { id: 'tier-5', label: '拉完了', color: 'bg-white', textColor: 'text-black', items: [] },
        ];

        // --- 全局状态 ---
        const state = {
            tiers: JSON.parse(JSON.stringify(INITIAL_TIERS)),
            poolItems: [],
            mainTitle: "万物分级排序器",
            poolTitle: "备选图片库",
            modal: { type: null, isOpen: false },
            draggedItem: null,
            dragSource: null
        };

        // --- 核心逻辑 ---

        function renderItem(item, tierId, source) {
            const dragProps = `
                draggable="true"
                ondragstart="handleDragStart(event, '${item.id}', '${source}')"
                ondblclick="deleteItem('${item.id}', '${source}')"
            `;

            // 核心样式逻辑：
            // 1. alignment: 如果 item.customAlign 是 'center'，则使用 self-center；否则（默认或 'line'）往下偏移吸附底线。
            // 2. 叠压: -ml-6
            // 3. 悬停: 统一归位、放大、置顶
            
            let posClass = '';
            
            if (tierId) {
                // 默认为 line (吸附底线)
                const isCenter = item.customAlign === 'center';
                
                if (isCenter) {
                    // 居中模式：self-center 让它垂直居中，y轴无偏移
                    posClass = `self-center -ml-6 first:ml-0 hover:scale-110 hover:z-[100] hover:shadow-2xl z-10 border-2 border-[#2a2a2a] transition-all duration-200 ease-out`;
                } else {
                    // 骑线模式 (默认)：向下偏移 50%
                    posClass = `translate-y-1/2 -ml-6 first:ml-0 hover:translate-y-0 hover:scale-110 hover:z-[100] hover:shadow-2xl z-10 border-2 border-[#2a2a2a] transition-all duration-200 ease-out`;
                }
            }

            return `
                <div 
                    class="relative group w-20 h-20 sm:w-24 sm:h-24 flex-shrink-0 cursor-grab active:cursor-grabbing ${posClass}"
                    ${dragProps}
                >
                    <img src="${item.url}" class="w-full h-full object-cover rounded shadow-md pointer-events-none select-none bg-gray-800">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all rounded"></div>
                    
                    ${/* 调试/提示用：显示当前对齐状态 (可选，这里不显示保持界面干净) */ ''}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            // 1. Modal HTML
            let modalHtml = '';
            if (state.modal.isOpen) {
                const isReset = state.modal.type === 'reset';
                modalHtml = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
                    <div class="relative bg-gray-800 border border-gray-600 rounded-lg shadow-2xl w-full max-w-sm overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-white mb-2">${isReset ? '重置排序?' : '⚠️ 彻底清空?'}</h3>
                            <p class="text-gray-300 text-sm leading-relaxed mb-6">
                                ${isReset 
                                    ? '这将把所有已分级的图片移回下方的备选库，不会删除图片。'
                                    : '这将永久删除当前所有的图片（包括备选库和已排序的），此操作无法撤销。'
                                }
                            </p>
                            <div class="flex justify-end gap-3">
                                <button onclick="closeModal()" class="px-4 py-2 rounded text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-700 transition-colors">取消</button>
                                <button onclick="confirmModal()" class="px-4 py-2 rounded text-sm font-bold text-white shadow-lg transition-colors ${isReset ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-600 hover:bg-red-700'}">
                                    ${isReset ? '确认重置' : '确认清空'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // 2. Tiers HTML
            const tiersHtml = state.tiers.map((tier, index) => {
                const zIndex = 50 - index; 
                return `
                <div class="flex relative group/row" style="z-index: ${zIndex}">
                    <!-- 左侧标签：固定正方形 (w-28 h-28 -> w-32 h-32) -->
                    <div class="${tier.color} ${tier.textColor} w-28 h-28 sm:w-32 sm:h-32 flex-shrink-0 flex items-center justify-center border-r-2 border-b-2 border-gray-800 relative shadow-lg z-20">
                        <textarea 
                            oninput="updateTierLabel('${tier.id}', this.value)"
                            class="w-full h-full bg-transparent text-center resize-none border-none focus:ring-0 p-2 flex items-center justify-center overflow-hidden font-black text-lg sm:text-xl leading-tight placeholder-white/50 focus:bg-black/10 transition-colors cursor-text"
                            style="line-height: 1.2; padding-top: 35%">${tier.label}</textarea>
                    </div>
                    
                    <!-- 放置区域 -->
                    <!-- items-end: 默认底部对齐 (支持骑线) -->
                    <!-- flex-wrap: 允许换行 -->
                    <!-- min-h-[128px]: 确保格子高度足够体现出"居中"和"骑线"的区别 -->
                    <div 
                        class="drop-zone flex-1 bg-[#1a1a1a] border-b-2 border-gray-600 pl-8 pr-4 flex flex-wrap items-end content-end gap-y-0 tier-container relative transition-all min-h-[8rem] sm:min-h-[8rem]"
                        data-type="tier"
                        data-id="${tier.id}"
                        ondragover="handleDragOver(event)"
                        ondrop="handleDrop(event, '${tier.id}')"
                    >
                        ${tier.items.map(item => renderItem(item, tier.id, tier.id)).join('')}

                        ${tier.items.length === 0 ? `
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0 pb-2">
                                <span class="text-gray-600 text-[10px] sm:text-xs uppercase tracking-widest opacity-40 select-none px-2">
                                    拖拽至中部：居中放置
                                </span>
                                <span class="text-gray-600 text-[10px] sm:text-xs uppercase tracking-widest opacity-40 select-none px-2 mt-1">
                                    拖拽至底部：吸附底线
                                </span>
                            </div>` : ''}
                    </div>
                </div>
            `}).join('');

            // 3. Pool Items HTML
            const poolItemsHtml = state.poolItems.map(item => `
                <div class="relative group">
                     ${renderItem(item, null, 'pool')}
                </div>
            `).join('');

            // 4. Main Template
            app.innerHTML = `
                ${modalHtml}
                
                <!-- 头部 -->
                <header class="text-center w-full max-w-3xl pt-6">
                    <div class="relative group inline-block w-full">
                        <input 
                            value="${state.mainTitle}"
                            oninput="updateMainTitle(this.value)"
                            class="text-3xl sm:text-4xl font-bold text-white bg-transparent text-center w-full border-b-2 border-transparent hover:border-gray-600 focus:border-blue-500 focus:outline-none transition-all px-2 py-1"
                            placeholder="输入标题..."
                        />
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity text-gray-600">
                            ${ICONS.edit}
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm mt-2">支持两种放置方式：拖拽至格子中部居中，拖拽至底部吸附底线。</p>
                </header>

                <!-- 主排序区 -->
                <div class="w-full border-4 border-gray-800 rounded-lg shadow-2xl bg-black flex flex-col gap-0 pb-16">
                    ${tiersHtml}
                </div>

                <!-- 备选区 -->
                <div class="w-full bg-gray-800 rounded-xl p-4 shadow-xl border border-gray-700 flex flex-col gap-4">
                    <!-- 工具栏 -->
                    <div class="flex flex-col md:flex-row justify-between items-center pb-2 border-b border-gray-700 gap-4 md:gap-0">
                        <div class="flex items-center gap-2 group w-full md:w-auto">
                            <div class="text-gray-500">${ICONS.grip}</div>
                            <input 
                                value="${state.poolTitle}"
                                oninput="updatePoolTitle(this.value)"
                                class="text-xl font-bold text-white bg-transparent border-b border-transparent hover:border-gray-500 focus:border-white focus:outline-none transition-colors w-full sm:w-64"
                            />
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-500">${ICONS.edit}</div>
                        </div>

                        <!-- 扩展的工具按钮组 -->
                        <div class="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                            <button onclick="requestReset()" class="px-3 py-2 text-xs bg-blue-900/40 hover:bg-blue-800 text-blue-100 border border-blue-800 rounded transition-colors flex items-center gap-1">
                                ${ICONS.rotate} <span class="hidden sm:inline">重置</span>
                            </button>
                            <div 
                                onclick="requestClear()"
                                ondragover="handleDragOver(event)"
                                ondrop="handleTrashDrop(event)"
                                class="group relative px-4 py-2 min-w-[100px] bg-red-900/20 hover:bg-red-900/50 border-2 border-dashed border-red-800 hover:border-red-500 rounded cursor-pointer transition-all flex items-center justify-center gap-2 text-red-300 hover:text-white"
                            >
                                ${ICONS.trash}
                                <span class="text-xs font-bold">删除/清空</span>
                            </div>
                        </div>
                    </div>

                    <!-- 图片池 -->
                    <div 
                        class="drop-zone min-h-[140px] bg-[#111] rounded-lg p-4 flex flex-wrap gap-3 items-start border-2 border-dashed border-gray-700 content-start"
                        data-type="pool"
                        ondragover="handleDragOver(event)"
                        ondrop="handleDrop(event, 'pool')"
                    >
                        <div 
                            onclick="document.getElementById('fileInput').click()"
                            class="w-20 h-20 sm:w-24 sm:h-24 flex-shrink-0 flex flex-col items-center justify-center bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white border border-gray-600 rounded cursor-pointer transition-all"
                        >
                            <div class="mb-1">${ICONS.upload}</div>
                            <span class="text-xs">导入图片</span>
                            <input type="file" id="fileInput" class="hidden" multiple accept="image/*" onchange="handleFileUpload(this)">
                        </div>
                        ${poolItemsHtml}
                        ${state.poolItems.length === 0 ? `<div class="flex-1 h-24 flex items-center justify-center text-gray-600 select-none pointer-events-none text-sm">点击左侧方块导入图片</div>` : ''}
                    </div>
                </div>
            `;
        }

        // --- 交互处理器 ---

        function updateMainTitle(val) { state.mainTitle = val; }
        function updatePoolTitle(val) { state.poolTitle = val; }
        function updateTierLabel(id, val) {
            const tier = state.tiers.find(t => t.id === id);
            if(tier) tier.label = val;
        }

        function handleFileUpload(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            const newItems = files.map(file => ({
                id: `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                type: 'image',
                url: URL.createObjectURL(file),
                name: file.name
            }));
            
            state.poolItems.push(...newItems);
            input.value = ''; 
            render();
        }

        // --- 拖拽逻辑 ---

        function handleDragStart(e, itemId, source) {
            let item;
            if (source === 'pool') {
                item = state.poolItems.find(i => i.id === itemId);
            } else {
                const tier = state.tiers.find(t => t.id === source);
                item = tier ? tier.items.find(i => i.id === itemId) : null;
            }

            if (item) {
                state.draggedItem = item;
                state.dragSource = source;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', itemId);
                
                // 优化拖拽样式
                setTimeout(() => {
                    if (e.target) e.target.classList.add('opacity-50');
                }, 0);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e, targetId) {
            e.preventDefault();
            const draggedItem = state.draggedItem;
            const source = state.dragSource;

            if (!draggedItem) return;

            // 1. 从源移除
            if (source === 'pool') {
                state.poolItems = state.poolItems.filter(i => i.id !== draggedItem.id);
            } else {
                const sourceTier = state.tiers.find(t => t.id === source);
                if (sourceTier) {
                    sourceTier.items = sourceTier.items.filter(i => i.id !== draggedItem.id);
                }
            }

            // 2. 核心逻辑：检测落点高度，决定布局方式
            // 如果目标是 Tier，我们需要计算鼠标在 dropZone 内的相对位置
            if (targetId !== 'pool') {
                const dropZone = e.currentTarget;
                const rect = dropZone.getBoundingClientRect();
                const relativeY = e.clientY - rect.top; // 鼠标距离容器顶部的距离
                const zoneHeight = rect.height;
                
                // 阈值判断：如果落在下半部分 (例如 > 60%)，则视为"骑线"，否则视为"居中"
                // 60% 是个经验值，用户拖到底部意图更明显
                const isBottom = relativeY > (zoneHeight * 0.6);
                
                draggedItem.customAlign = isBottom ? 'line' : 'center';
            } else {
                // 回到 pool 清除对齐属性
                delete draggedItem.customAlign;
            }

            // 3. 添加到目标
            let targetList;
            if (targetId === 'pool') {
                targetList = state.poolItems;
            } else {
                const targetTier = state.tiers.find(t => t.id === targetId);
                targetList = targetTier ? targetTier.items : null;
            }

            if (targetList) {
                targetList.push(draggedItem);
            }

            // 重置状态
            state.draggedItem = null;
            state.dragSource = null;
            render();
        }

        function handleTrashDrop(e) {
            e.preventDefault();
            const draggedItem = state.draggedItem;
            const source = state.dragSource;
            
            if (!draggedItem) return;

            if (source === 'pool') {
                state.poolItems = state.poolItems.filter(i => i.id !== draggedItem.id);
            } else {
                const sourceTier = state.tiers.find(t => t.id === source);
                if (sourceTier) {
                    sourceTier.items = sourceTier.items.filter(i => i.id !== draggedItem.id);
                }
            }
            
            // 仅对图片释放内存
            if (draggedItem.type === 'image' && draggedItem.url) {
                URL.revokeObjectURL(draggedItem.url);
            }

            state.draggedItem = null;
            state.dragSource = null;
            render();
        }

        function deleteItem(itemId, source) {
            let itemToDelete;
            if (source === 'pool') {
                itemToDelete = state.poolItems.find(i => i.id === itemId);
                state.poolItems = state.poolItems.filter(i => i.id !== itemId);
            } else {
                const tier = state.tiers.find(t => t.id === source);
                if (tier) {
                    itemToDelete = tier.items.find(i => i.id === itemId);
                    tier.items = tier.items.filter(i => i.id !== itemId);
                }
            }
            
            if (itemToDelete && itemToDelete.type === 'image' && itemToDelete.url) {
                URL.revokeObjectURL(itemToDelete.url);
            }
            render();
        }

        // --- Modal 逻辑 ---

        function requestReset() {
            const hasItems = state.tiers.some(t => t.items.length > 0);
            if (!hasItems) return;
            state.modal = { type: 'reset', isOpen: true };
            render();
        }

        function requestClear() {
            const hasItems = state.poolItems.length > 0 || state.tiers.some(t => t.items.length > 0);
            if (!hasItems) return;
            state.modal = { type: 'clear', isOpen: true };
            render();
        }

        function closeModal() {
            state.modal = { type: null, isOpen: false };
            render();
        }

        function confirmModal() {
            if (state.modal.type === 'reset') {
                const allTierItems = state.tiers.flatMap(t => t.items);
                // 重置时清除对齐属性
                allTierItems.forEach(i => delete i.customAlign);
                state.poolItems.push(...allTierItems);
                state.tiers.forEach(t => t.items = []);
            } else if (state.modal.type === 'clear') {
                [...state.poolItems, ...state.tiers.flatMap(t => t.items)].forEach(item => {
                    if (item.type === 'image' && item.url) URL.revokeObjectURL(item.url);
                });
                state.poolItems = [];
                state.tiers.forEach(t => t.items = []);
            }
            closeModal();
        }

        // --- 初始化 ---
        render();

        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());

    </script>
</body>
</html>
